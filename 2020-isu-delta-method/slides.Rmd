---
title: "The Delta Method and msm R Rackage"
author: 
  - "<br>"
  - "Iowa State University, Ecology 607"
  - "November 16, 2020"
  - "Katherine Goode (kgoode\\@iastate.edu)"
date: "<br><br>Find slides at: goodekat.github.io/presentations.html"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{css, echo = FALSE}
.tiny{font-size: 30%}
.small{font-size: 50%}
.medium{font-size: 75%}
```

```{r setup, include = FALSE}
# R packages
library(knitr)
library(xaringanthemer)

options(htmltools.dir.version = FALSE)

# R markdown options
opts_chunk$set(
  dpi = 200,
  message = FALSE,
  fig.align = "center"
)
```

```{r xaringan-themer, include = FALSE, warning = FALSE}
style_mono_accent(
  base_color = "#1c5253",
  header_font_google = google_font("Josefin Sans"),
  text_font_google = google_font("Montserrat", "300", "300i"),
  code_font_google = google_font("Fira Mono"),
  text_slide_number_color = "black",
  header_h1_font_size = "2rem",
  header_h2_font_size = "1.75rem",
  header_h3_font_size = "1.25rem",
  colors = c(orange = "#ff8811"), 
  link_color = "#07A1D3"
)
```

# Background: AES stats consulting

- Offer help with data analyses for ISU researchers (includes graduate students, post docs, faculty, and staff)

- Consulting website: [https://www.stat.iastate.edu/statistical-consulting](https://www.stat.iastate.edu/statistical-consulting)

```{r echo = FALSE, out.width = "90%"}
include_graphics("figures/aes.png")
```

---

# Slide structure

<br>

1. What is the delta method?  

2. Mathematical details  

3. Delta method in R by hand

4. Delta method in R via `msm`

---

class: inverse, center, middle

# What is the delta method?

---

## Computing a confidence interval

Suppose you take measurements of the length of 30 frogs and want to compute:

- mean length

- standard deviation of lengths

- confidence interval for a mean

What do you need to compute a confidence interval for a mean?

<br>

```{r echo = FALSE, out.width = "45%"}
include_graphics("figures/frog.jpeg")
```

---

## Standard error

**Standard error**: estimate of variability associated with a statistic

**Example:**

Confidence interval for a sample mean:

<br>

$$\bar{y} \pm z \cdot \mbox{SE}\left[\bar{y}\right]$$

<br>

where $\bar{y}$ is the sample mean, $z$ is a normal quantile, and

<br>

$$\mbox{SE}\left[\bar{y}\right] = \mbox{sd}\left[\bar{y}\right] = \sqrt{Var\left[\bar{y}\right]} = \frac{s}{\sqrt{n}}$$

<br>

where $s$ is the sample standard deviation and $n$ is the sample size.

---

## Computing standard errors

Some standard errors are easy to derive/compute (like a sample mean)

<br>

$$
\begin{array}
\mbox{SE}\left[\bar{y}\right] & = & \sqrt{Var\left[\frac{1}{n} \sum_{i=1}^n y_i \right]} \\
& = & \sqrt{\left(\frac{1}{n}\right)^2\left(\sum_{i=1}^n Var\left[y_i\right]\right)}\\
& = & \sqrt{\frac{1}{n^2}\left(n Var\left[y_i \right]\right)}\\
& = & \sqrt{\frac{1}{n}Var\left[y_i\right]}\\
& = & \frac{\sqrt{Var\left[y_i\right]}}{\sqrt{n}}\\
& = & \frac{s}{\sqrt{n}}
\end{array}
$$

<br>

Others do not...

---

## Estimating tricky standard errors

<br>

**Delta method**: approach to approximate standard errors of transformed parameters

<br>

If

- want a SE for a parameter estimate

- doesn't have a commonly used formula, is accessible via software, or derived easily

and

- parameter estimate is a function of other parameters with known SEs

- some other assumptions are met (to be discussed)

then

- **delta method** can be used to compute the standard error

---

## Mule deer example

Suppose you have data on mule deer survival and calculate several quantities:

<br>

**(1) Logistic regression equation in MARK for quarterly survival:**

$$\log\left(\frac{S_i}{1-S_i}\right)=\beta_0+\beta_1\cdot\mbox{age}_i+\beta_2\cdot \mbox{age}_i^2$$

for $i=1,...,n$ where $S_i$ represents the quarterly survival at $\mbox{age}_i$

<br>

**(2) Quarterly survival estimates for specific ages:**

$$S_i=\frac{\exp\left(\beta_0+\beta_1\cdot\mbox{age}_i+\beta_2\cdot\mbox{age}_i^2\right)}{1+\exp\left(\beta_0+\beta_1\cdot\mbox{age}_i+\beta_2\cdot\mbox{age}_i^2\right)}.$$

<br>

**(3) Annual survival for a specific age:** $\ \ \ (S_i)^4$

---

## Try it out

Suppose that you are interested in obtaining confidence intervals for the $\beta$'s, $S_i$ and $(S_i)^4$. Which would you need to use the delta method to derive?

<br>
<br>

- $\beta$'s

<br>

- $S_i$

<br>

- $(S_i)^4$

---

## Try it out: Solution

Suppose that you are interested in obtaining confidence intervals for the $\beta$'s, $S_i$ and $(S_i)^4$. Which would you need to use the delta method to derive?

<br>
<br>

- $\beta$'s - No

<br>

- $S_i$ - Technically can get from MARK but is (probably) derived using the delta method

<br>

- $(S_i)^4$ - Will need to derive the standard error using delta method

---

## Summary

<br>

- Standard errors estimate variability associated with a statistic

<br>

- Standard errors are often used to compute confidence intervals

<br>

- **Delta method can be used to approximate standard errors of transformed parameters that are not easy to compute**

---

class: inverse, center, middle

# Mathematical details

---

## Definitions and conditions

| Value | Definition | Conditions |
| :---: | :--------: | :-------: |
| $$\boldsymbol{\theta}=(\theta_1,...,\theta_p)$$ |  parameter vector | has mean $\boldsymbol{\theta}$ and variance-covariance matrix $Cov(\boldsymbol{\theta})$ |
| $$\hat{\boldsymbol{\theta}}$$ | sequence of estimators of $\boldsymbol{\theta}$ | asymptotically normal |
| $$g(\boldsymbol{\theta})$$ | function of $\boldsymbol{\theta}$ | real-valued and continuously differentiable in a neighborhood of $\boldsymbol{\theta}$ |
| $$g\left(\hat{\boldsymbol{\theta}}\right)$$ | estimate of $g(\boldsymbol{\theta})$ | - |
| $\textbf{d}$ | vector of partial derivatives of length $p$ with a $j$th element of $$\frac{\partial g(\boldsymbol{\theta})}{\partial \theta_j}$$ | - |

---

## The Delta Method

**Situation/conditions**

- Parameter estimate $g\left(\hat{\boldsymbol{\theta}}\right)$ a function of parameters $\hat{\boldsymbol{\theta}}$
- $\boldsymbol{\theta}$ has known variance covariance matrix $Cov\left(\hat{\boldsymbol{\theta}}\right)$

**Results**

- $g\left(\hat{\boldsymbol{\theta}}\right)$ follows a normal distribution:

$$g\left(\hat{\boldsymbol{\theta}}\right) \sim N\left(g(\boldsymbol{\theta}), \ \textbf{d}Cov\left(\hat{\boldsymbol{\theta}}\right)\textbf{d}'\right)$$

- .orange[Standard error of] $g\left(\hat{\boldsymbol{\theta}}\right)$ .orange[can be computed as]

$$SE\left(g\left(\hat{\boldsymbol{\theta}}\right)\right)=\sqrt{Cov\left(g\left(\hat{\boldsymbol{\theta}}\right)\right)}=\sqrt{\textbf{d}Cov\left(\hat{\boldsymbol{\theta}}\right)\textbf{d}'}.$$ 

- <small> (Note that $Cov\left(\hat{\boldsymbol{\theta}}\right)$ is estimated by the negative inverse Hessian matrix) </small>

---

## Try it out

Want to compute standard error for $S_i^4$ where 

$$S_i=\frac{\exp\left(\beta_0+\beta_1\cdot\mbox{age}_i+\beta_2\cdot\mbox{age}_i^2\right)}{1+\exp\left(\beta_0+\beta_1\cdot\mbox{age}_i+\beta_2\cdot\mbox{age}_i^2\right)}$$

What is the notation in this context?

- $\boldsymbol{\theta}=(\theta_1,...,\theta_p)$

- $\hat{\boldsymbol{\theta}}_n$

- $g(\boldsymbol{\theta})$

- $g\left(\hat{\boldsymbol{\theta}}\right)$

- $\textbf{d}$

---

## Try it out: Solution

Want to compute standard error for $S_i^4$ where 

$$S_i=\frac{\exp\left(\beta_0+\beta_1\cdot\mbox{age}_i+\beta_2\cdot\mbox{age}_i^2\right)}{1+\exp\left(\beta_0+\beta_1\cdot\mbox{age}_i+\beta_2\cdot\mbox{age}_i^2\right)}$$

What is the notation in this context?

- $\boldsymbol{\theta}=(\theta_1,...,\theta_p)=\boldsymbol{\beta}=\left(\beta_0, \beta_1, \beta_2\right)$

- $\hat{\boldsymbol{\theta}}_n=\hat{\boldsymbol{\beta}}_n=\left(\hat{\beta}_0, \hat{\beta}_1, \hat{\beta}_2\right)$

- $g(\boldsymbol{\theta})=S^4=g\left(\boldsymbol{\beta}\right) =\left(\frac{\exp\left(\beta_0+\beta_1\cdot\mbox{age}+\beta_2\cdot\mbox{age}^2\right)}{1+\exp\left(\beta_0+\beta_1\cdot\mbox{age}+\beta_2\cdot\mbox{age}^2\right)}\right)^4$

- $g\left(\hat{\boldsymbol{\theta}}\right)=\hat{S^4} = g\left(\hat{\boldsymbol{\beta}}_n\right)=\left(\frac{\exp\left(\hat{\beta}_0+\hat{\beta}_1\cdot\mbox{age}+\hat{\beta}_2\cdot\mbox{age}^2\right)}{1+\exp\left(\hat{\beta}_0+\hat{\beta}_1\cdot\mbox{age}+\hat{\beta}_2\cdot\mbox{age}^2\right)}\right)^4$

- $\textbf{d}=\left(\frac{\partial g(\boldsymbol{\beta})}{\partial \beta_0}, \frac{\partial g(\boldsymbol{\beta})}{\partial \beta_1}, \frac{\partial g(\boldsymbol{\beta})}{\partial \beta_2}\right)$

---

## Computing mule deer standard error

<br>

Now, how to compute the standard error for $S_i^4$?

<br>

$$SE\left(g\left(\hat{\boldsymbol{\beta}}\right)\right)=\sqrt{\textbf{d}Cov\left(\hat{\boldsymbol{\beta}}\right)\textbf{d}'}$$ 

<br>

Would need to:

- Derive partial derivatives in $\textbf{d}$ (see next slide)

- Compute partial derivatives using estimated parameters from the logistic regression model

- Extract variance-covariance matrix from logistic regression for $Cov\left(\hat{\boldsymbol{\beta}}\right)$

- Use formula above to put it all together  for computing $SE\left(g\left(\hat{\boldsymbol{\beta}}\right)\right)$

---

## Mule deer derivatives

The partial derivatives of $g\left(\boldsymbol{\beta}\right)$ in terms of $\beta_0, \beta_1$, and $\beta_2$:

<small>
$$\begin{array}{ccl}
\textbf{d}' & = & \left[\begin{array}{ccc} \frac{\partial}{\partial\beta_0} \left(S^4\right) & \frac{\partial}{\partial\beta_1} \left(S^4\right) & \frac{\partial}{\partial\beta_2} \left(S^4\right) \end{array}\right]'\\
& = & \left[\begin{array}{l} \frac{\partial}{\partial \beta_0} \left(\frac{\exp\left(\beta_0+
\beta_1\cdot\mbox{age}+\beta_2\cdot\mbox{age}^2\right)}{1+\exp\left(\beta_0+
\beta_1\cdot\mbox{age}+\beta_2\cdot\mbox{age}^2\right)}\right)^4 \\ \frac{\partial}{\partial \beta_1} \left(\frac{\exp\left(\beta_0+
\beta_1\cdot\mbox{age}+\beta_2\cdot\mbox{age}^2\right)}{1+\exp\left(\beta_0+
\beta_1\cdot\mbox{age}+\beta_2\cdot\mbox{age}^2\right)}\right)^4 \\ 
\frac{\partial}{\partial \beta_2} \left(\frac{\exp\left(\beta_0+
\beta_1\cdot\mbox{age}+\beta_2\cdot\mbox{age}^2\right)}{1+\exp\left(\beta_0+
\beta_1\cdot\mbox{age}+\beta_2\cdot\mbox{age}^2\right)}\right)^4 \end{array} \right]\\
& = & \left[\begin{array}{l}
4\left(\frac{\exp\left(\beta_0+\beta_1\cdot\mbox{age}+\beta_2\cdot\mbox{age}^2\right)}{1+\exp\left(\beta_0+\beta_1\cdot\mbox{age}+\beta_2\cdot\mbox{age}^2\right)}\right)^4\left(1-\frac{\exp\left(\beta_0+\beta_1\cdot\mbox{age}+\beta_2\cdot\mbox{age}^2\right)}{1+\exp\left(\beta_0+\beta_1\cdot\mbox{age}+\beta_2\cdot\mbox{age}^2\right)}\right)\\
4\left(\frac{\exp\left(\beta_0+\beta_1\cdot\mbox{age}+\beta_2\cdot\mbox{age}^2
\right)}{1+\exp\left(\beta_0+\beta_1\cdot\mbox{age}+\beta_2\cdot\mbox{age}^2\right)}
\right)^4\left(1-\frac{\exp\left(\beta_0+\beta_1\cdot\mbox{age}+\beta_2\cdot\mbox{age}^2\right)}{1+\exp\left(\beta_0+\beta_1\cdot\mbox{age}+\beta_2\cdot\mbox{age}^2\right)}\right)(\mbox{age})\\
4\left(\frac{\exp\left(\beta_0+\beta_1\cdot\mbox{age}+\beta_2\cdot\mbox{age}^2\right)}{1+\exp\left(\beta_0+\beta_1\cdot\mbox{age}+\beta_2\cdot\mbox{age}^2\right)}\right)^4\left(1-\frac{\exp\left(\beta_0+\beta_1\cdot\mbox{age}+\beta_2\cdot\mbox{age}^2\right)}{1+\exp\left(\beta_0+\beta_1\cdot\mbox{age}+\beta_2\cdot\mbox{age}^2\right)}\right)(\mbox{age}^2)
\end{array}\right]\\
& = & \left[\begin{array}{l} 4S^4(1-S) \\ 4S^4(1-S)(\mbox{age}) \\ 4S^4(1-S)(\mbox{age})^2 \end{array}\right]
\end{array}.$$
</small>

---

## Summary

- For parameters $\hat{\boldsymbol{\theta}}$ with a known variance covariance matrix $Cov\left(\hat{\boldsymbol{\theta}}\right)$:

  - Can use the delta method to obtain a standard error for a transformation of the parameters: $g\left(\hat{\boldsymbol{\theta}}\right)$ 
  
- Delta method standard error formula:

$$SE\left(g\left(\hat{\boldsymbol{\theta}}\right)\right)=\sqrt{\textbf{d}Cov\left(\hat{\boldsymbol{\theta}}\right)\textbf{d}'}$$

- Involves computing partial derivatives

---

class: inverse, center, middle

# Delta method in R by hand

---

## Mule deer example in R

### MARK model results

```{r}
# R packages
library(dplyr); library(readr)
```

```{r}
# Load data frame of quarterly survival, quarterly survival, 
# standard error of quarterly survival, and annual survival 
# computed based on the logistic regression model fit in MARK
survival_data <- read_csv("data/age_and_survival.csv")

# Print the head of the data
head(survival_data)
```

---

## Mule deer logisitc regression estimates

### Model coefficients

```{r}
# Load logistic regression coefficient estimates
betas <- read_csv("data/betas.csv", col_names = FALSE) %>% as.matrix()
betas
```

### Variance-covariance matrix

```{r}
# Load estimated variance covariance matrix of the logistic regression coefficients
vcov <- read_csv("data/vcov.csv", col_names = FALSE) %>% as.matrix()
vcov
```

---

## Hand written R function 

`compute_annual_se`: Function for computing annual survival standard error via the delta method

Inputs:  

- `age`: age at which to compute the annual survival estimate and standard error
- `betas`: estimated logistic regression coefficients (vector of length 3)
- `vcov`: estimated variance covariance matrix of logistic regression coefficients (3x3 matrix)

Output: data frame with the variables of...

- `age`: age that was specified for the computations
- `annual_survival`: estimated annual survival for specified `age`
- `se`: standard error for annual survival (estimated using delta method)
- `lower`: lower bound of 95% confidence interval for annual survival
- `upper`: upper bound of 95% confidence interval for annual survival

---

.tiny[
```{r}
# Function for computing annual survival standard error
compute_annual_se <- function(age, betas, vcov){

  # Separate the betas
  b0 <- betas[1]; b1 <- betas[2]; b2 <- betas[3]

  # Compute logit of quarterly survival for given age
  logit_s <- b0 + (b1 * age) + (b2 * (age^2))

  # Compute quarterly and annual survival
  s <- exp(logit_s) / (1 + exp(logit_s))
  annual <- s^4
  
  # Create empty 1x3 matrix to store the elements of d
  d <- matrix(NA, nrow = 1, ncol = 3)

  # Compute elements of d (partial derivatives of g(beta))
  d[1] <- 4 * (s^4) * (1 - s)
  d[2] <- 4 * age * (s^4) * (1 - s)
  d[3] <- 4 * (age^2) * (s^4) * (1 - s)

  # Compute standard error of annual survival (using delta method)
  se <- sqrt(d %*% vcov %*% t(d)) #<<
  
  # Compute lower and upper bounds of 95% CI for annual survival
  lower <- annual - (1.96 * se); upper <- annual + (1.96 * se) #<<

  # Return age, annual survival estimate, standard error, 95% CI
  return(data.frame(age, annual_survival = annual, se, lower, upper))

}
```
]

---

## Applying the function to one age

```{r fig.showtext = TRUE}
# Apply compute_annual_se when age is 1
age1_se <-
  compute_annual_se(
    age = survival_data$age[1],
    betas = betas,
    vcov = vcov
  )

# Print the results (rounded to 2 decimals)
age1_se
```

---

## Applying the function to multiple ages

```{r}
# Apply compute_annual_se to all of the ages in survival data
# using map_df from purrr to apply .f to all elements of .x
survival_data_annual <- 
  purrr::map_df(
    .x = survival_data$age, 
    .f = compute_annual_se, #<<
    betas = betas,
    vcov = vcov
  )

# Print part of the results
head(survival_data_annual)
```

---

## Annual surival by age with confidence intervals

```{r fig.width = 8, fig.height = 4, out.width = "75%"}
# Plot the estimated annual survival and confidence intervals
library(ggplot2)
ggplot(survival_data_annual, aes(x = age, y = annual_survival)) +
  geom_line() +
  geom_line(aes(x = age, y = lower), linetype = "dashed", color = "blue") +
  geom_line(aes(x = age, y = upper), linetype = "dashed", color = "blue") +
  scale_x_continuous(breaks = seq(1, 11, 1)) +
  labs(x = "Age", y = "Annual Surivial") +
  theme_xaringan()
```

---

## Summary

- Could code up a function to compute a delta method standard error in R by hand

- Can use the functions of `map` or `map_df` from `purrr` to apply a function easily to multiple inputs 

---

class: inverse, center, middle

# Delta method in R via msm

---

## msm R package

**Package overview**

- **M**ulti-**S**tate **M**arkov models

- From the online [documentation](https://cran.r-project.org/web/packages/msm/index.html)

> R package for continuous-time multi-state modeling of panel data

- From the [vignette](https://cran.r-project.org/web/packages/msm/vignettes/msm-manual.pdf):

> The multi-state Markov model is a useful way of describing a process in which an individual moves through a series of states in continuous time. The msm package for R allows a general multi-state model to be fitted to longitudinal data.

- **Provides an easier way to apply the delta method**:

  - Includes a `deltamethod` function
  
  - Prevents the computation of partial derivatives (Yay! `r emo::ji("smile")`)

---

## `deltamethod` function

Inputs:

- `g` = a formula representing the function: $g(\cdot)$ 
  
> The variables must be labeled `x1`, `x2`,... For example:
  ```{r eval = FALSE}
  g = ~ 1 / (x1 + x2)
  ```

- `mean	` = vector of estimated parameters: $\hat{\boldsymbol{\theta}}$

- `cov` = estimated variance-covariance matrix: $Cov\left(\hat{\boldsymbol{\theta}}\right)$

- `ses`: If TRUE, returns the standard errors of $g(\cdot)$ (default). If FALSE, returns the variance-covariance matrix of $g(\cdot)$.

---

## Example 1

.pull-left[
Simple linear regression:

$$\hat{y}=\hat{\beta}_0+\hat{\beta}_1x_1$$
]

.pull-right[
Compute standard error for 

$$\frac{1}{\hat{\beta}_0+\hat{\beta}_1}$$
]

```{r}
# Simple linear regression
set.seed(1000)
x1 <- 1:100; y <- rnorm(100, 4*x1, 5)
m1 <- lm(y ~ x1)

# Extract the model coefficients and variance-covariance matrix
bhat1 <- coef(m1)
vc1 <- vcov(m1)

# Estimate of (1 / (b0hat + b1hat))
1 / (bhat1[[1]] + bhat1[[2]])

# Approximate standard error
msm::deltamethod(g = ~ 1 / (x1 + x2), mean = bhat1, cov = vc1)                     
```

---

## Example 2

.pull-left[
Simple linear regression:

$$\hat{y}=\hat{\beta}_0+\hat{\beta}_1x_1+\hat{\beta}x_2$$
]

.pull-right[
Compute standard error for 

$$\frac{1}{\hat{\beta}_0+\hat{\beta}_1}$$
]

```{r}
# Simple linear regression
set.seed(1000)
x1 <- 1:100; x2 <- runif(100); y <- rnorm(100, 4*x1, 5)
m2 <- lm(y ~ x1 + x2)

# Extract the model coefficients and variance-covariance matrix
bhat2 <- coef(m2)[1:2]
vc2 <- vcov(m2)[1:2,1:2]

# Estimate of (1 / (b0hat + b1hat))
1 / (bhat2[[1]] + bhat2[[2]])

# Approximate standard error
msm::deltamethod(g = ~ 1 / (x1 + x2), mean = bhat2, cov = vc2)
```

---

## Try it out

For the mule deer example, compute the standard error for $\hat{S^4}$ when $\mbox{age}=1$.

$$\hat{S^4}=\left(\frac{\exp\left(\hat{\beta}_0+\hat{\beta}_1\cdot\mbox{age}+\hat{\beta}_2\cdot\mbox{age}^2\right)}{1+\exp\left(\hat{\beta}_0+\hat{\beta}_1\cdot\mbox{age}+\hat{\beta}_2\cdot\mbox{age}^2\right)}\right)^4$$

<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

Bonus: How to compute the standard error for $\hat{S^4}$ for an arbitrary age?

---

## Try it out: Solution

For the mule deer example, compute the standard error for $\hat{S^4}$ when $\mbox{age}=1$.

$$\hat{S^4}=\left(\frac{\exp\left(\hat{\beta}_0+\hat{\beta}_1\cdot\mbox{age}+\hat{\beta}_2\cdot\mbox{age}^2\right)}{1+\exp\left(\hat{\beta}_0+\hat{\beta}_1\cdot\mbox{age}+\hat{\beta}_2\cdot\mbox{age}^2\right)}\right)^4$$

<br>

```{r}
# Create the form of the formula to put in the deltamethod function
formula = "~ (exp(x1 + x2 + x3)) / (1 + exp(x1 + x2 + x3))^4"

# Apply the deltamethod function
se = msm::deltamethod(as.formula(formula), mean = betas, cov = vcov)
se
```

<br>

Bonus: How to compute the standard error for $\hat{S^4}$ for an arbitrary age in R?

> See next slide

---

## Arbitrary age

Function for applying the msm function deltamethod to a specified age:

```{r}
apply_msm_deltamethod <- function(age, betas, vcov){

  # Create the form of the formula to put in the deltamethod function
  formula <- 
    sprintf("~ (exp(x1 + (x2 * %f) + (x3 * %f)) /
            (1 + exp(x1 + (x2 * %f) + (x3 * %f))))^4", 
            age, age^2, age, age^2)

  # Apply the deltamethod function
  se = msm::deltamethod(as.formula(formula), mean = betas, cov = vcov)

  # Return the se in a dataframe
  return(data.frame(age, se))

}
```

```{r}
apply_msm_deltamethod(1, betas, vcov)
```

---

## Multiple ages

We could also use `map_df` to apply the function to multiple ages

```{r}
purrr::map_df(.x = 1:11, .f = apply_msm_deltamethod, betas, vcov)
```

---

## Summary

- `deltamethod` function in `msm` R package allows application of delta method without computing derivatives

- Need to input a formula that uses `x1`, `x2`,... for the parameters $\hat{\boldsymbol{\theta}}$

- Only extract the parameter estimates and corresponding variance-covariance matrix cells needed to compute the transformed parameter

<br>
<br>

**Additional resources**

- A good reference on the delta method that also describes how to apply the delta method in R can be found on the [IDRE website](https://stats.idre.ucla.edu/r/faq/how-can-i-estimate-the-standard-error-of-transformed-regression-parameters-in-r-using-the-delta-method/).

- Another delta method function ([`delta.method`](https://www.rdocumentation.org/packages/alr3/versions/1.1.12/topics/delta.method#:~:text=estimated%20regression%20coefficients-,delta.,known%20or%20estimated%20covariance%20matrix)) the [alr3](https://www.rdocumentation.org/packages/alr3/versions/1.1.12) R package